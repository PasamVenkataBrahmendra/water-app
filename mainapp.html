import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:http/http.dart' as http;

void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'Smart Water Control',
      theme: ThemeData(
        primarySwatch: Colors.blue,
      ),
      home: DashboardScreen(),
    );
  }
}

class DashboardScreen extends StatefulWidget {
  @override
  _DashboardScreenState createState() => _DashboardScreenState();
}

class _DashboardScreenState extends State<DashboardScreen> {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseMessaging _firebaseMessaging = FirebaseMessaging.instance;

  double waterUsage = 0.0;
  
  @override
  void initState() {
    super.initState();
    _firebaseMessaging.requestPermission();
    _getWaterUsage();
  }

  void _getWaterUsage() {
    _firestore.collection('water_usage').doc('home').snapshots().listen((snapshot) {
      if (snapshot.exists) {
        setState(() {
          waterUsage = snapshot['usage'].toDouble();
        });
      }
    });
  }

  Future<void> _sendCommand(String command) async {
    String url = 'http://your-backend-server.com/api/smart-home';
    await http.post(Uri.parse(url), body: {'command': command});
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Smart Water Control')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text('Water Usage: $waterUsage L', style: TextStyle(fontSize: 24)),
            SizedBox(height: 20),
            ElevatedButton(
              onPressed: () => _sendCommand('turn_on'),
              child: Text('Turn On Water Harvesting'),
            ),
            ElevatedButton(
              onPressed: () => _sendCommand('turn_off'),
              child: Text('Turn Off Water Harvesting'),
            ),
          ],
        ),
      ),
    );
  }
}
